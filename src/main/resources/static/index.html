<!DOCTYPE html>
<html>

<head>
    <title>Jeopardy Spiel</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link href="/main.css" rel="stylesheet">

    <link rel="stylesheet" href="node_modules/primer-css/build/build.css">
    <link rel="stylesheet" href="node_modules/octicons/build/font/octicons.css">
</head>

<body>
    <h1>Willkommen zum Jeopardy-Spiel</h1>
    <div class="container-fluid">
        <div class="row">
            <div class="col col-9">

            </div>
            <div class="col">
                <table class="table table-bordered table-striped table-light">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col" class="text-end col-md-auto">Platz</th>
                            <th scope="col" style="width: 75%;">Name</th>
                            <th scope="col" class="text-end">Score</th>
                        </tr>
                    </thead>
                    <tbody id="lobby">
                    </tbody>
                </table>
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg btn-block" onclick="joinGame()" id="join">Spiel
                        beitreten</button>
                </div>
            </div>
        </div>
    </div>

    <div id="question"></div>
    <div id="scoreboard"></div>

    <div id="alert" class="fixed-bottom m-5"></div>

    <script>
        let stompClient;

        const connect = () => {
            const socket = new SockJS('/jeopardy');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, () => {
                // TODO: Add needed subscriptions to updates when implemented

                // subscribes to user specific messages about lobby join information. Displays a message when joined successfully.
                stompClient.subscribe("/user/topic/join", (msg) => {
                    const join = document.getElementById("join");
                    join.hidden = true;

                    showAlert('success', `${JSON.parse(msg.body) ? 'Herzlich Willkommen' : 'Willkommen zurÃ¼ck'}! Jeden Moment sollte das Spiel starten!`);
                });

                // subscribes to lobby update messages and rebuilds the lobby table according to the given informations about the lobby.
                stompClient.subscribe("/topic/lobby-update", (msg) => {
                    const q = JSON.parse(msg.body);

                    const lobby = document.getElementById("lobby");

                    const rowCount = lobby.rows.length;
                    for (var i = 0; i < rowCount; i++) {
                        lobby.deleteRow(0);
                    }

                    for (var i = 0; i < q.length; i++) {
                        var row = lobby.insertRow(-1);

                        var place = document.createElement("th");
                        place.scope = "row"
                        place.classList.add("text-end")
                        place.innerText = i + 1;

                        row.appendChild(place);

                        var name = row.insertCell(1);
                        name.innerText = q[i].name;

                        var score = row.insertCell(2);
                        score.innerText = q[i].score;
                        score.classList.add("text-end")
                    }

                    // TODO: Send more information for a detailed update analysis and more detailed notification to the players.
                    showAlert('info', `Die Lobby wurde geupdated!`);
                });
            });

        }

        // joinGame prompts the user to enter a name for themselves and sends given name to the backend
        function joinGame() {
            const name = prompt("Bitte gib deinen Namen ein:");
            stompClient.send("/app/join", {}, name);
        }


        // showAlert is a simple utility function, that displays an information / notification for the player.
        // type and message are required to identify the type of message ('danger', 'success', 'warning', etc.) and the content of the message.
        // duration is the display duration of the notification and if omitted will default to 5 seconds.
        function showAlert(type, message, duration) {
            const alertPlaceholder = document.getElementById('alert')
            const wrapper = document.createElement('div')
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible" role="alert">`,
                `   ${message}`,
                '</div>'
            ].join('')

            alertPlaceholder.append(wrapper)

            setTimeout(() => wrapper.remove(), duration || 5000);
        }

        connect();
    </script>
</body>

</html>